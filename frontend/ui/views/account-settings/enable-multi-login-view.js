import React from 'react'
import PropTypes from 'prop-types'
import {observer} from 'mobx-react'
import authenticator from 'authenticator'
import kjua from 'kjua'
import AccountKeypair from '../../state/account-keypair'
import Auth2FaApps from 'auth-2fa-apps-view'

@observer
class EnableMultiLoginView extends React.Component {
    constructor(props) {
        super(props)
        this.state = {
            totpKey: authenticator.generateKey(),
            verificationCode: null
        }
    }

    static propTypes = {
        account: PropTypes.instanceOf(Keypair).isRequired
    }

    setup2fa() {
        if (!this.state.verificationCode) return
    }

    generateQRCode() {
        let key = this.state.totpKey.replace(/\W/g, '').toLowerCase(),
            qrCode = kjua({
                ecLevel: 'H',
                size: 160,
                text: `otpauth://totp/StellarExpertID?secret=${key}`, //TODO: include email into otpauth
                fill: '#141414',
                quiet: 1,
                rounded: 40
            })

        return qrCode.src
    }

    renderEmailPrompt(){

    }

    render() {
        let account = this.props.account
        if (account.useMultiLogin) return <div>
            Two-Factor Authentication is already enabled for this account.
            <br/>
            Do you want to <a href={`/account/${account.address}/disable-multi-login`}>disable</a> it?
        </div>

        return <div>
            <h2>Set up two-factor authorization</h2>
            <div className="section">
                <b>1. Install a 2FA authenticator app.</b>
                <div>
                    Download and install authenticator application like <Auth2FaApps/>.
                </div>
            </div>
            <div className="section">
                <b>2. Launch the authenticator and add new account.</b>
            </div>
            <div className="section">
                <b>3. Select "Scan a barcode" option and use your phone's camera to scan this barcode.</b>
                <div><img src={this.generateQRCode()}/></div>
            </div>
            <div className="section">
                <b>4. Once you have scanned the barcode, enter a 6-digit verification code generated by the
                    authenticator app.</b>
                <div>
                    <input type="text" maxLength={8} onChange={e => this.setState({verificationCode: e.target.value})}/>
                </div>
            </div>
            <div className="actions space">
                <button disabled={!this.state.verificationCode} onClick={e => this.setup2fa()}>Verify and Save</button>
                <a href={`/account/${account.address}`}>Cancel</a>
            </div>
        </div>
    }
}

export default EnableMultiLoginView